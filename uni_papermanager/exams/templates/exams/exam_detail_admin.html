{% extends 'base.html' %}

{% block title %}{{ exam.exam_title }} - Admin{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'exam_list_admin' %}">My Exams</a></li>
        <li class="breadcrumb-item active">{{ exam.exam_title }}</li>
    </ol>
</nav>

<!-- Exam Header -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h2 class="mb-3">{{ exam.exam_title }}</h2>
                
                <div class="mb-3">
                    <p class="mb-2">
                        <strong><i class="fas fa-book me-2"></i>Course:</strong> 
                        <a href="{% url 'course_detail' exam.course.course_id %}">
                            {{ exam.course.course_name }}
                        </a>
                    </p>
                    <p class="mb-2">
                        <strong><i class="fas fa-graduation-cap me-2"></i>Program:</strong> 
                        {{ exam.course.program.program_name }}
                    </p>
                    <p class="mb-0">
                        <strong><i class="fas fa-building me-2"></i>Department:</strong> 
                        {{ exam.course.program.department.department_name }}
                    </p>
                </div>

                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2">
                            <strong><i class="fas fa-calendar-alt me-2"></i>Start Time:</strong><br>
                            {{ exam.start_time|date:"l, F d, Y" }}<br>
                            {{ exam.start_time|date:"g:i A" }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2">
                            <strong><i class="fas fa-calendar-check me-2"></i>End Time:</strong><br>
                            {{ exam.end_time|date:"l, F d, Y" }}<br>
                            {{ exam.end_time|date:"g:i A" }}
                        </p>
                    </div>
                </div>

                <p class="mb-0 mt-2">
                    <strong><i class="fas fa-clock me-2"></i>Duration:</strong> 
                    {% widthratio exam.end_time.timestamp exam.start_time.timestamp 1 as duration_seconds %}
                    {{ duration_seconds|floatformat:0 }} seconds
                    ({{ exam.end_time|timeuntil:exam.start_time }})
                </p>
            </div>

            <div class="col-md-4">
                <!-- Status Card -->
                {% load tz %}
                {% now "U" as current_timestamp %}
                {% if exam.is_active %}
                    <div class="alert alert-success">
                        <h5 class="alert-heading">
                            <i class="fas fa-play-circle me-2"></i>Exam is Active!
                        </h5>
                        <hr>
                        <p class="mb-2"><strong>Time Remaining:</strong></p>
                        <h4 class="text-success mb-0">
                            {{ exam.end_time|timeuntil }}
                        </h4>
                    </div>
                {% elif exam.start_time.timestamp > current_timestamp|add:"0" %}
                    <div class="alert alert-info">
                        <h5 class="alert-heading">
                            <i class="fas fa-clock me-2"></i>Upcoming Exam
                        </h5>
                        <hr>
                        <p class="mb-2"><strong>Starts in:</strong></p>
                        <h4 class="text-info mb-0">
                            {{ exam.start_time|timeuntil }}
                        </h4>
                    </div>
                {% else %}
                    <div class="alert alert-secondary">
                        <h5 class="alert-heading">
                            <i class="fas fa-check-circle me-2"></i>Exam Completed
                        </h5>
                        <hr>
                        <p class="mb-0">
                            <strong>Ended:</strong><br>
                            {{ exam.end_time|date:"M d, Y H:i" }}
                        </p>
                    </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="d-grid gap-2 mt-3">
                    <a href="{% url 'update_exam' exam.exam_id %}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit Exam
                    </a>
                    <a href="{% url 'delete_exam' exam.exam_id %}" 
                       class="btn btn-danger"
                       onclick="return confirm('Are you sure you want to delete this exam? All submissions and results will be permanently deleted.')">
                        <i class="fas fa-trash me-2"></i>Delete Exam
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ enrolled_students }}</h3>
                <p class="mb-0"><i class="fas fa-users me-2"></i>Enrolled Students</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-success">{{ submissions.count }}</h3>
                <p class="mb-0"><i class="fas fa-paper-plane me-2"></i>Total Submissions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ pending_grading }}</h3>
                <p class="mb-0"><i class="fas fa-hourglass-half me-2"></i>Pending Grading</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-info">{{ graded_count }}</h3>
                <p class="mb-0"><i class="fas fa-check-circle me-2"></i>Graded</p>
            </div>
        </div>
    </div>
</div>

<!-- Submissions Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Submissions</h5>
    </div>
    <div class="card-body">
        {% if submissions %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Email</th>
                        <th>Submission Time</th>
                        <th>File</th>
                        <th>Status</th>
                        <th>Grade</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for submission in submissions %}
                    <tr>
                        <td><strong>{{ submission.student.user.full_name }}</strong></td>
                        <td>{{ submission.student.user.email }}</td>
                        <td>{{ submission.submission_time|date:"M d, Y H:i" }}</td>
                        <td>
                            <a href="{{ submission.file_path.url }}" 
                               class="btn btn-sm btn-outline-primary" 
                               download
                               title="Download submission">
                                <i class="fas fa-download me-1"></i>Download
                            </a>
                        </td>
                        <td>
                            {% if submission.result %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Graded
                                </span>
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-clock me-1"></i>Pending
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if submission.result %}
                                <span class="badge 
                                    {% if submission.result.grade == 'A+' or submission.result.grade == 'A' %}bg-success
                                    {% elif submission.result.grade == 'B+' or submission.result.grade == 'B' or submission.result.grade == 'A-' %}bg-info
                                    {% elif submission.result.grade == 'C+' or submission.result.grade == 'C' or submission.result.grade == 'B-' %}bg-warning
                                    {% else %}bg-danger{% endif %} fs-6">
                                    {{ submission.result.grade }} ({{ submission.result.marks }}%)
                                </span>
                            {% else %}
                                <span class="text-muted">Not graded</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if submission.result %}
                                <a href="{% url 'grade_submission' submission.submission_id %}" 
                                   class="btn btn-sm btn-outline-secondary"
                                   title="Edit Grade">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </a>
                            {% else %}
                                <a href="{% url 'grade_submission' submission.submission_id %}" 
                                   class="btn btn-sm btn-primary"
                                   title="Grade Submission">
                                    <i class="fas fa-star me-1"></i>Grade
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Grade Distribution -->
        {% if graded_count > 0 %}
        <div class="card mt-4 bg-light">
            <div class="card-body">
                <h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Grade Distribution</h6>
                <div class="row text-center">
                    {% regroup submissions by result.grade as grade_list %}
                    {% for grade_group in grade_list %}
                    {% if grade_group.grouper %}
                    <div class="col">
                        <div class="card">
                            <div class="card-body p-2">
                                <h5 class="
                                    {% if grade_group.grouper == 'A+' or grade_group.grouper == 'A' %}text-success
                                    {% elif grade_group.grouper == 'B+' or grade_group.grouper == 'B' %}text-info
                                    {% elif grade_group.grouper == 'C+' or grade_group.grouper == 'C' %}text-warning
                                    {% else %}text-danger{% endif %} mb-1">
                                    {{ grade_group.grouper }}
                                </h5>
                                <small class="text-muted">{{ grade_group.list|length }}</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
            <h5>No Submissions Yet</h5>
            <p class="text-muted mb-0">
                {% if exam.is_active %}
                    Students can submit their exams now. Submissions will appear here.
                {% elif exam.start_time > now %}
                    Students will be able to submit once the exam starts.
                {% else %}
                    No students submitted this exam before the deadline.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Action Buttons -->
<div class="mt-4">
    <a href="{% url 'exam_list_admin' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Exams
    </a>
    <a href="{% url 'course_enrollments' exam.course.course_id %}" class="btn btn-outline-info">
        <i class="fas fa-users me-2"></i>View Enrolled Students
    </a>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        padding: 20px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stat-card.danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .stat-card h3 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .stat-card p {
        margin-bottom: 0;
        opacity: 0.9;
    }
</style>
{% endblock %}